name: Auto Format (Black + Ruff)

on:
  workflow_dispatch:
    inputs:
      # OPCIONAL: menú estático de ramas (puedes editar la lista)
      branch:
        description: "Select branch to format (optional; otherwise use the branch in the top 'Run workflow' dropdown)"
        required: false
        type: choice
        options:
          - ""        # empty = use the branch selected in GitHub's built-in dropdown
          - main
          - develop
          - release

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (selected or current)
        uses: actions/checkout@v4
        with:
          # Prioridad:
          # 1) Input 'branch' si eliges una opción no vacía del menú propio
          # 2) La rama que elijas en el dropdown nativo "Run workflow → Branch"
          ref: ${{ inputs.branch != '' && inputs.branch || github.ref }}
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install formatters
        run: |
          python -m pip install --upgrade pip
          pip install "ruff==0.5.7" "black==24.8.0"

      - name: Ruff (fix)
        run: ruff check . --fix

      - name: Black (format)
        run: black .

      - name: Create Pull Request if changes
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "style: apply Ruff fixes and Black formatting"
          title: "style: auto-format (Ruff + Black)"
          body: |
            Automated formatting run:
            - ruff check --fix
            - black .
          branch: chore/auto-format/${{ github.run_id }}
          delete-branch: true
